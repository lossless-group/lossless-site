---
// site/src/pages/learn-with/up-and-running/index.astro
// Collection-specific page for up-and-running collection with toggle navigation

import { getCollection, type CollectionEntry } from 'astro:content';
import GuideIndexLayout from '../../../layouts/GuideIndexLayout.astro'; 
import { slugify } from '../../../utils/slugify'; 
import { collectionPublishingDefaults } from '../../../content.config'; 
import Hero from '../../../components/basics/Hero.astro';
import AnimationWrapper from '../../../components/basics/AnimationWrapper.astro';

// Define the entry type for the up-and-running collection
interface UpAndRunningEntry {
  id: string;
  data: {
    title?: string;
    slug?: string;
    date?: string | Date;
    lede?: string;
    description?: string;
    publish?: boolean;
    tags?: string | string[];
  };
}

// Get all up-and-running entries
const allEntriesUnfiltered = await getCollection('up-and-running') as unknown as UpAndRunningEntry[];

// Apply publishing filter logic
const defaultPublishBehavior = collectionPublishingDefaults['up-and-running']?.publishByDefault ?? true;

const allEntries = allEntriesUnfiltered.filter((entry) => {
  const itemPublishFlag = entry.data?.publish; 
  
  if (defaultPublishBehavior === true) {
    return itemPublishFlag !== false;
  }
  return itemPublishFlag === true;
});

// Collection configuration for up-and-running
const collectionConfig = {
  title: 'Up and Running',
  subtitle: "Get started quickly with our guides.",
  description: 'Quick start guides and tutorials to help you get up and running with various technologies and tools.'
};

// Transform entries for up-and-running collection
const guides = allEntries.map((entry) => {
  const data = entry.data as any;
  
  function normalizeToArray(singularKey: string, pluralKey: string): string[] {
    const singularValue = data?.[singularKey];
    const pluralValue = data?.[pluralKey];
    
    const combined = [singularValue, pluralValue].filter(Boolean).flat();
    return combined.length > 0 ? combined : [];
  }
  
  const customSlug = data?.slug || slugify(data?.title || entry.id);
  
  let dateValue = data?.date_of_event || data?.date;
  if (dateValue instanceof Date) {
    dateValue = dateValue.toISOString().split('T')[0];
  }
  
  return {
    id: entry.id, 
    title: data?.title || 'Untitled',
    slug: customSlug, 
    collection: 'up-and-running',
    banner_image: data?.banner_image, 
    portrait_image: data?.portrait_image, 
    imageAlt: `Image for ${data?.title || 'Untitled'}`, 
    date: dateValue,
    date_of_event: dateValue,
    lede: data?.lede || data?.description || '', 
    tags: normalizeToArray('tag', 'tags'),
    participants: normalizeToArray('participant', 'participants'),
    categories: normalizeToArray('category', 'categories'),
  };
}).sort((a, b) => {
  // Sort by date descending (most recent first)
  if (!a.date && !b.date) return 0;
  if (!a.date) return 1;
  if (!b.date) return -1;
  
  const dateA = new Date(a.date);
  const dateB = new Date(b.date);
  return dateB.getTime() - dateA.getTime();
});
---

<GuideIndexLayout
  title={collectionConfig.title} 
  description={collectionConfig.description}
  guides={guides}
  collectionDisplayName={collectionConfig.title} 
>
  <div slot="hero-content" style="position: relative;">
    <AnimationWrapper>
      <Hero
        title={collectionConfig.title}
        subtitle={collectionConfig.subtitle}
        description={collectionConfig.description}
        alignment="center"
        fullBleed={false}
        animate={true}
      />
    </AnimationWrapper>
  </div>
</GuideIndexLayout>

<style>
  .chevron-navigation {
    position: absolute;
    top: 40%;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    pointer-events: none;
  }
  
  .chevron-navigation a {
    pointer-events: auto;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
  }
  
  .chevron-navigation a:hover {
    background: white;
    transform: scale(1.1);
  }
  
  .chevron-navigation svg {
    width: 24px;
    height: 24px;
    color: var(--color-text);
  }
  
  @media (max-width: 768px) {
    .chevron-navigation {
      display: none;
    }
  }
</style>