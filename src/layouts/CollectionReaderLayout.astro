---
// site/src/layouts/CollectionReaderLayout.astro

import { unified } from 'unified';
import remarkParse from 'remark-parse';
import remarkGfm from 'remark-gfm';
import remarkImages from '@utils/markdown/remark-images'; 
import remarkBacklinks from '@utils/markdown/remark-backlinks';
import remarkCitations from '@utils/markdown/remark-citations';
import remarkTableOfContents from '@utils/markdown/remark-toc';
import type { Root } from 'mdast';

import CollectionSidebar from '@components/articles/ContentNavSidebar.astro';
import OneArticleOnPage from '@components/articles/OneArticleOnPage.astro';
import { markdownDebugger } from '@utils/markdown/markdownDebugger';

// Props
interface Props {
  collection: string;
  entry: any;
  essays: any[];
}

const { collection, entry, essays } = Astro.props as Props;
console.log('[CollectionReaderLayout.astro] Received essays prop:', essays);

let mdastNode = null;
let tocNode = null;
let contentData = null;

const effectiveEntry = entry ?? (essays.length > 0 ? essays[0] : null);

// Process markdown content
if (effectiveEntry) {
  const processor = unified()
    .use(remarkParse)
    .use(remarkGfm)
    .use(remarkImages) 
    .use(remarkBacklinks)
    .use(remarkCitations)
    .use(remarkTableOfContents);

  const mdast = processor.parse(effectiveEntry.body || '');
  mdastNode = await processor.run(mdast);

  markdownDebugger.log('CollectionReaderLayout.astro Debug');
  markdownDebugger.writeDebugFile('collection-reader-mdast', mdastNode);
  markdownDebugger.verbose('MDAST structure:', mdastNode);

  tocNode = mdastNode.children?.find(child => child.type === 'tableOfContents');

  contentData = {
    path: effectiveEntry.id,
    id: effectiveEntry.id,
    collection,
    ...effectiveEntry.data
  };
}
---

<div class="collection-reader-layout">
  <aside class="collection-sidebar">
    <div class="sidebar-inner">
      <CollectionSidebar essays={essays} currentSlug={entry ? entry.id : null} />
    </div>
  </aside>

  <main class="collection-reader-pane">
    {effectiveEntry && mdastNode && contentData ? (
      <OneArticleOnPage 
        content={mdastNode} 
        data={contentData} 
      />
    ) : (
      <h2>No entries available in collection: {collection}</h2>
    )}
  </main>
</div>


<style>
.collection-reader-layout {
  display: flex;
  flex-direction: row;
  width: 100%;
  height: auto;
  overflow: visible;
}

.collection-sidebar {
  width: 300px;
  min-width: 300px;
  max-width: 300px;
  flex-shrink: 0;
  border-right: 1px solid var(--clr-lossless-ui-btn-border, #ccc);
  overflow-y: auto;
  position: sticky;
  top: 4rem; /* Adjust for header height */
  height: 100%;
  padding: 1rem;
  background: var(--clr-sidebar-bg, #111);
  transition: width 0.3s ease-in-out;
}

.sidebar-inner {
  width: 100%;
  min-width: 0;
}

.collection-reader-pane {
  flex: 1 1 auto;
  display: block; /* simpler layout */
  padding: 3rem 2rem;
  min-width: 0;
  overflow: visible;
}

@media (max-width: 1024px) {
  .collection-reader-layout {
    flex-direction: column;
  }

  .collection-sidebar {
    position: relative;
    width: 100%;
    max-width: 100%;
    min-width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid var(--clr-lossless-ui-btn-border, #ccc);
    padding: 1rem 0;
    top: auto; /* ✅ Reset sticky top! */

    box-sizing: border-box; /* ✅ VERY important */
    flex-shrink: 0;          /* ✅ prevent flex from shrinking sidebar */
    
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 1; /* Optional — ensure sidebar sits above content if needed */
  }


  .collection-reader-pane {
    padding: 1rem;
  }
}

@media (min-width: 1025px) {
  .collection-sidebar:hover {
    width: 500px;
    max-width: 500px;
  }
}
</style>
