---
const { code } = Astro.props;
const chartId = `mermaid-chart-${Math.random().toString(36).slice(2, 10)}`;
import ExpandIcon from '@assets/Icons/arrows-maximize.svg';
import CollapseIcon from '@assets/Icons/arrows-minimize.svg';

---
<div id={chartId} class="mermaid-breakout" tabindex="0">
  <div class="mermaid-chart-shell">
    <!-- Accessible, pure HTML/CSS expand/collapse toggle for Mermaid chart -->
     <!-- TODO: Make fullscreen toggle work -->
    <!-- <input type="checkbox" id={`toggle-${chartId}`} class="mermaid-toggle-checkbox" hidden>
    <label for={`toggle-${chartId}`} class="mermaid-expand-toggle" tabindex="0" aria-label="Expand/collapse chart">
      <span class="expand-icon">
        <ExpandIcon class="icon-expand" />
        <CollapseIcon class="icon-collapse" />
      </span>
    </label> -->
    <div class="mermaid">{code}</div>
  </div>
</div>

<!-- Fullscreen modal markup will be injected by JS when needed -->



<style>
.mermaid-breakout {
  position: relative;
  z-index: 9999;
  left: 50%;
  right: 50%;
  width: 100vw;
  margin-left: -50vw;
  max-width: 100vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: transparent;
  box-sizing: border-box;
}
.mermaid-chart-shell {
  position: relative;
  min-width: 600px;
  width: 80vw;
  max-width: 1000px;
  margin: 1.25rem 0;
  overflow-x: auto;
  background: var(--bastille);
  box-shadow: 0 4px 48px rgba(0,0,0,0.25);
  border-radius: 10px;
  border: 2px solid var(--lossless-accent--brightest);
  margin: 0 auto;
  display: block;
  padding: 1rem;
}
.mermaid {
  background: transparent !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  margin: 0 !important;
}
.mermaid-chart-shell .mermaid-expand-toggle {
  position: absolute;
  top: 0.75rem;
  right: 1.5rem;
  z-index: 10;
  background: none;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
}
.mermaid-chart-shell .mermaid-expand-toggle:hover, .mermaid-chart-shell .mermaid-expand-toggle:focus {
  opacity: 1;
  outline: 2px solid #88f;
}
/* Only show ExpandIcon when NOT checked */
.icon-collapse { display: none; }
.mermaid-toggle-checkbox:checked + .mermaid-expand-toggle .icon-expand { display: none; }
.mermaid-toggle-checkbox:checked + .mermaid-expand-toggle .icon-collapse { display: inline; }
</style>



<script is:inline>
  // Mermaid rendering logic (custom base theme, transparent background)
  // Dynamically resolve CSS variable for primary text color at runtime
  function getCssVar(name, fallback) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback;
  }

  const bodyColor = getCssVar('--clr-body', '#e0e0e0');
  const primaryNodeBg = getCssVar('--clr-primary-bg', '#181818');
  const secondaryNodeBg = getCssVar('#64F4a4');
  const edgeLabelBg = getCssVar('--clr-aquamarine', '#64d4a4');
  const hippieBlue = getCssVar('--clr-hippie-blue', '#50a3b3');
  const secondaryTextClr = getCssVar('--clr-hippie-blue', '#50a3b3');
  const clusterBkg = getCssVar('--clr-gunmetal', '#283139');
  const lineClr = getCssVar('--clr-aqua-brightest', '#69e2e3');
  const fontFmly = 'Open Sans, sans-serif';

  const mermaidConfig = {
    startOnLoad: true,
    theme: 'base', // Use base for full customizability
    themeVariables: {
      darkMode: true,
      background: 'transparent', // No background for SVG/chart
      primaryColor: primaryNodeBg,
      primaryBorderColor: '#6fffd6',
      primaryTextColor: bodyColor,
      secondaryColor: '#BF23F7',
      secondaryTextColor: secondaryTextClr,
      clusterBkg: clusterBkg,
      lineColor: lineClr,
      fontFamily: fontFmly,
      // Add more custom variables here as needed
    }
  };

  if (!window.__MERMAID_LOADED__) {
    import('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs')
      .then((mermaid) => {
        mermaid.default.initialize(mermaidConfig);
        mermaid.default.run();
        window.mermaid = mermaid.default;
        window.__MERMAID_LOADED__ = true;
      })
      .catch(console.error);
  } else {
    window.mermaid?.initialize(mermaidConfig);
    window.mermaid?.run();
  }
</script>
