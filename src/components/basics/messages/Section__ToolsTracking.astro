---
import TagCloud from "@components/tool-components/TagCloud.astro";
import ToolCount from "@components/basics/ToolCount.astro";
import TrademarkRibbon from "@components/trademarks/TrademarkRibbon.astro";
import { getCollection } from "astro:content";

interface Tool {
  url: string;
  site_name?: string;
  title?: string;
  image?: string;
  favicon?: string;
  description?: string;
  tags?: string[];
  id: string;
}

const TRADEMARK_CONFIG = {
  sourceDir: "./public/visuals/Tooling-Trademarks/usable--darkmode",
};

const toolEntries = await getCollection("tooling");
const tools = toolEntries.map(entry => ({ ...entry.data, id: entry.id } as Tool));

const tagFrequencies = tools.reduce(
  (tagCounts: Record<string, number>, tool: Tool) => {
    tool.tags?.forEach((tag: any) => {
      tagCounts[tag] = (tagCounts[tag] || 0) + 1;
    });
    return tagCounts;
  },
  {} as Record<string, number>
);

// Get all unique tags from all tools
const allTags = [
  ...new Set(
    tools.flatMap((tool) => tool.tags || []).filter((tag) => tag) // Remove any undefined/null values
  ),
];
---

<section class="tools-tracking-section">
  <div class="tools-header">
    <h2>We're tracking
      <ToolCount asBadge={true} />
      tools.
    </h2>
  </div>
  <div class="tools-tag-cloud">
    <TagCloud
      tags={allTags}
      tagFrequencies={tagFrequencies}
      visibleTagRowLimit={4}
      maxWidth="96%"
      tagRoute="toolkit"
    />
  </div>
</section>

<!-- Header for tech section - centered to viewport -->
<div class="tech-header">
  <h2>Tech we're watching.</h2>
</div>

<!-- Full-bleed ribbon container -->
<div id="ribbon-container">
  <div class="trademark-ribbon-wrapper">
    <TrademarkRibbon
      sourceDir={TRADEMARK_CONFIG.sourceDir}
      width="auto"
      maxWidth="92%"
    />
  </div>
</div>

<style>
  .tools-tracking-section {
    width: 100%;
    margin: 0 auto;
    padding: 2rem 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .tools-header {
    margin-bottom: 1rem;
    display: block;
    flex-direction: column;
    justify-content: center;
    gap: 2rem;
    width: 100%;
    & > h2 {
      text-align: center;
      font-size: var(--fs-500);
      font-weight: var(--fw-semi-bold);
    }
  }

  .tech-header {
    width: 100%;
    text-align: center;
    margin: 2rem auto 1rem auto;
  }
  
  .tech-header h2 {
    font-size: var(--fs-500);
    font-weight: var(--fw-semi-bold);
    margin: 0;
  }

  /* Full-bleed container for the ribbon */
  #ribbon-container {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    overflow: visible;
  }
  
  .trademark-ribbon-wrapper {
    width: 100%;
    overflow: visible;
  }
</style>