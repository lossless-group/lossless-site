---
interface Props {
    node: {
        type?: string;
        children?: Array<{
            type: string;
            children?: Array<{
                type: string;
                value?: string;
                url?: string;
                data?: {
                    hName?: string;
                    hProperties?: {
                        className?: string;
                        href?: string;
                        target?: string;
                        rel?: string;
                    };
                };
            }>;
            data?: {
                hName?: string;
                hProperties?: {
                    className?: string;
                };
            };
        }>;
        data?: {
            hProperties?: Record<string, any>;
        };
    };
}

const { node } = Astro.props;
const citations = node.children || [];

// Function to parse citation text and convert URLs to links
function parseCitation(text: string) {
    // Regular expression to match citation number and URL
    const regex = /\[(\d+)\]\s*(https?:\/\/[^\s]+)/;
    const match = text.match(regex);
    
    if (match) {
        const [_, number, url] = match;
        return {
            number,
            url: url.trim()
        };
    }
    
    return null;
}
---

<div class="citations">
    {citations.map((citation) => (
        <div class="citation" data-citation-type={citation.type}>
            {citation.children?.map((child) => {
                if (child.type === 'link') {
                    return (
                        <a href={child.url} target="_blank" rel="noopener noreferrer">
                            {child.children?.[0].value}
                        </a>
                    );
                }
                const parsed = parseCitation(child.value);
                return parsed ? (
                    <>
                        [{parsed.number}]{" "}
                        <a href={parsed.url} target="_blank" rel="noopener noreferrer">
                            {parsed.url}
                        </a>
                    </>
                ) : (
                    child.value
                );
            })}
        </div>
    ))}
</div>

<style>
    .citations {
        display: block;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--clr-lossless-accent--brightest);
    }

    .citation {
        display: block;
        font-size: 0.9rem;
        color: var(--clr-lossless-primary-light);
        opacity: 0.9;
        line-height: 1.8;
        padding-left: 2rem;
        text-indent: -2rem;
        margin-bottom: 0.5rem;
    }

    .citation:last-child {
        margin-bottom: 0;
    }

    .citation a {
        color: var(--clr-lossless-accent);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .citation a:hover {
        color: var(--clr-lossless-accent--brightest);
        text-decoration: underline;
    }
</style>
