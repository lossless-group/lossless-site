---
import type { Root, RootContent, Parent, PhrasingContent, Paragraph, CitationNode, CitationsNode } from 'mdast';
import AstroMarkdown from '../AstroMarkdown.astro';

interface Props {
  node: {
    type: string;
    children?: RootContent[];
    value?: string;
    data?: {
      hProperties?: Record<string, unknown>;
    };
  };
  data?: Record<string, unknown>;
}

const { node, data = {} } = Astro.props;

// Ensure data has required path property for AstroMarkdown
const markdownData = {
  path: '/default-path',
  ...data
};


// Default values
let calloutType = 'info';
let calloutTitle = '';

let contentNode: Root = { 
  type: 'root',
  children: node.children || []
};

// ====== TITLE EXTRACTION LOGIC ======

if (contentNode.children.length > 0) {
  const firstChild = contentNode.children[0];

  if (firstChild.type === 'paragraph' && Array.isArray(firstChild.children)) {
    const textNode = firstChild.children.find(child => child.type === 'text');

    if (textNode && typeof textNode.value === 'string') {
      const match = textNode.value.match(/^\[!(.*?)\]/);
      if (match) {
        calloutTitle = match[1].trim();

        // Remove the [!Title] from the paragraph text
        textNode.value = textNode.value.replace(/^\[!(.*?)\]\s*/, '');

        // If the paragraph is now empty after removing, delete it
        const isParagraphEmpty = firstChild.children.every(child => 
          child.type === 'text' && child.value.trim() === ''
        );
        if (isParagraphEmpty) {
          contentNode.children.shift(); // Remove the first child
        }
      }
    }
  }
}

// ====== End title extraction ======
---

<article class={`callout callout-${calloutType.toLowerCase()}`} data-debug-enabled>
  {calloutTitle && (
    <div class="callout-header">
      {calloutTitle}
    </div>
  )}
  <div class="callout-content">
    {contentNode.children.map(child => (
      <AstroMarkdown node={child} data={markdownData} />
    ))}
  </div>
</article>

<style>
  .callout {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 0.5rem;
    background-color: var(--clr-lossless-primary-dark);
    border: 1px solid var(--clr-lossless-accent--brightest);
  }

  .callout-header {
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--clr-lossless-accent--brightest);
    font-size: 1.1rem;
  }

 .callout {
  margin: 1rem 0;
  padding: 1rem;
  border-radius: 0.5rem;
  background-color: var(--clr-lossless-primary-dark);
  border: 1px solid var(--clr-lossless-accent--brightest);
  overflow: hidden; /* NEW: basic clipping */
}

.callout-content {
  color: var(--clr-lossless-primary-light);
  overflow-x: auto; /* NEW: allow horizontal scroll if needed */
  max-width: 100%;   /* NEW: prevent growing beyond container */
}

/* OPTIONAL: Style iframes inside callouts */
.callout-content iframe {
  max-width: 100%;
  height: auto;
  border: none;
}

/* OPTIONAL: Wrap tables nicely inside callouts */
.callout-content table {
  width: 100%;
  border-collapse: collapse;
}

/* Ensure images shrink inside callouts */
.callout-content img {
  max-width: 100%;
  height: auto;
  display: block;
}

/* Type-specific callout styling */
.callout-warning {
  background-color: rgba(255, 193, 7, 0.1);
  border-color: #ffc107;
  color: #856404;
}

.callout-warning .callout-header {
  color: #ffc107;
}

.callout-error {
  background-color: rgba(220, 53, 69, 0.1);
  border-color: #dc3545;
  color: #721c24;
}

.callout-error .callout-header {
  color: #dc3545;
}

.callout-success {
  background-color: rgba(40, 167, 69, 0.1);
  border-color: #28a745;
  color: #155724;
}

.callout-success .callout-header {
  color: #28a745;
}

.callout-info {
  background-color: rgba(23, 162, 184, 0.1);
  border-color: #17a2b8;
  color: #0c5460;
}

.callout-info .callout-header {
  color: #17a2b8;
}

.callout-tip {
  background-color: rgba(102, 16, 242, 0.1);
  border-color: #6610f2;
  color: #3d0a91;
}

.callout-tip .callout-header {
  color: #6610f2;
}

.callout-note {
  background-color: rgba(108, 117, 125, 0.1);
  border-color: #6c757d;
  color: #383d41;
}

.callout-note .callout-header {
  color: #6c757d;
}

.callout-quote {
  background-color: rgba(52, 58, 64, 0.1);
  border-color: #343a40;
  color: #1b1e21;
  border-left: 4px solid #343a40;
  font-style: italic;
}

.callout-quote .callout-header {
  color: #343a40;
}

.callout-emphasis {
  background-color: rgba(255, 107, 107, 0.1);
  border-color: #ff6b6b;
  color: #c92a2a;
  border-left: 4px solid #ff6b6b;
}

.callout-emphasis .callout-header {
  color: #ff6b6b;
  font-weight: 700;
}

</style>
