---
import type {Root, RootContent} from 'mdast'
import type {Root as HastRoot} from 'hast'
import {toHtml} from 'hast-util-to-html'
import {dirname} from 'path'
import remarkAsf from '@utils/markdown/remark-asf';
import remarkBacklinks from '@utils/markdown/remark-backlinks';
import remarkImages from '@utils/markdown/remark-images';
import remarkCallouts from '@utils/markdown/remark-callout-handler';
import ArticleCallout from './callouts/ArticleCallout.astro';

export interface Props {
    node: Root | RootContent;
    data: {
        path: string;
        [key: string]: any;
    };
}

const {node, data} = Astro.props;

// List of node types we handle with specific components
// Order matters! Container types (like blockquote) should be handled before their children (like paragraph)
const handled_types = [
    "root",
    "blockquote",  // Handle blockquotes before paragraphs since they contain paragraphs
    "paragraph",
    "text",
    "heading"
]

const other_type = !handled_types.includes(node.type)
data.dirpath = dirname(data.path)

// Debug output to see AST structure
console.log(`=== AstroMarkdown Debug ===`)
console.log(`Node type: ${node.type}`)
if (node.type === "blockquote") {
    console.log('Blockquote children:', JSON.stringify(node.children, null, 2))
}
---

{(node.type === "root") && 
    <>
        {node.children.map((child) => (
            <Astro.self node={child} data={data} />
        ))}
    </>
}

{(node.type === "blockquote") &&
    <ArticleCallout node={node} />
}

{(node.type === "paragraph") &&
    <div class="paragraph">
        {node.children.map((child) => (
            <Astro.self node={child} data={data} />
        ))}
    </div>
}

{(node.type === "text") && 
    <span>{node.value}</span>
}

{other_type && 
    <div class={`unhandled-${node.type}`}>
        {JSON.stringify(node)}
    </div>
}