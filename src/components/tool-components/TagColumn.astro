---
interface Props {
  tools: any[];
}

const { tools } = Astro.props;

const allTags = Array.from(new Set(tools.flatMap(tool => tool.tags || []))).sort();

function trainCaseToNormalCase(tag: string): string {
  return tag
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

const tagCounts = tools.reduce((acc, tool) => {
  (tool.tags || []).forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {});
---

<!-- Load Tom Select CSS + JS -->
<link
  href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<div class="tag-panel">
  <h3 class="tag-heading">Filter by Tag</h3>

  <button id="clear-tags" class="clear-tags-btn">Clear All</button>

  <!-- Tom Select-enhanced <select multiple> -->
  <select
    id="tag-select"
    multiple
    data-all-tags={JSON.stringify(allTags)}
    data-tag-counts={JSON.stringify(tagCounts)}
  >
    {allTags.map(tag => (
      <option value={tag}>{`${trainCaseToNormalCase(tag)} (${tagCounts[tag]})`}</option>
    ))}
  </select>
</div>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const tagSelectEl = document.getElementById('tag-select');
    const clearBtn = document.getElementById('clear-tags');
    const allCards = Array.from(document.querySelectorAll('.tool-card'));

    // Initialize Tom Select
    const tomSelect = new TomSelect(tagSelectEl, {
      plugins: ['remove_button'],
      maxItems: null, // unlimited selection
      searchField: ['text'],
      closeAfterSelect: false,
      placeholder: 'Search tags...',
    });

    function getSelectedTags() {
      return tomSelect.getValue(); // returns array of selected values
    }

    function filterCards() {
      const selectedTags = getSelectedTags();

      allCards.forEach(card => {
        const tags = JSON.parse(card.dataset.tags || '[]');
        const match = selectedTags.every(tag => tags.includes(tag));
        card.style.display = match || selectedTags.length === 0 ? '' : 'none';
      });
    }

    tagSelectEl.addEventListener('change', filterCards);

    clearBtn?.addEventListener('click', () => {
      tomSelect.clear();
      filterCards();
    });

    // Initial reveal
    allCards.forEach(card => {
      if (card.offsetParent !== null) {
        card.classList.add('fade-in');
      }
    });
  });
</script>

<style>
  .tag-panel {
    padding: 1rem;
    background: var(--clr-sidebar-bg);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .tag-heading {
    font-size: 1rem;
    font-weight: 600;
    color: white;
  }

  .clear-tags-btn {
    background: transparent;
    border: 1px solid white;
    color: white;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    align-self: start;
  }

  .clear-tags-btn:hover {
    background-color: white;
    color: black;
  }

  #tag-select {
    display: block;
    width: 100%;
    padding: 0.4rem;
    font-size: 1rem;
  }
</style>
