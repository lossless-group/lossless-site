---
import SortAscLetters from '@assets/Icons/sort-ascending-letters.svg';
import SortDescLetters from '@assets/Icons/sort-descending-letters.svg';
import SortAscNumbers from '@assets/Icons/sort-ascending-numbers.svg';
import SortDescNumbers from '@assets/Icons/sort-descending-numbers.svg';

interface Props {
  tools: any[];
}

const { tools } = Astro.props;

const allTags = Array.from(new Set(tools.flatMap(tool => tool.tags || []))).sort();

function trainCaseToNormalCase(tag: string): string {
  return tag
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

const tagCounts = tools.reduce((acc, tool) => {
  (tool.tags || []).forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  }); 
  return acc;
}, {});
---

<div class="tag-panel">
  <h3 class="tag-heading">Filter by Tag</h3>

  <div class="tag-actions">
    <button id="sort-alpha-asc" class="sort-btn" title="Sort A → Z"><SortAscLetters /></button>
    <button id="sort-alpha-desc" class="sort-btn" title="Sort Z → A"><SortDescLetters /></button>
    <button id="sort-count-desc" class="sort-btn" title="Sort by Count ↓"><SortDescNumbers /></button>
    <button id="sort-count-asc" class="sort-btn" title="Sort by Count ↑"><SortAscNumbers /></button>
  
    <button id="clear-tags" class="clear-tags-btn">Clear All</button>
  </div>

  <select
    id="tag-select"
    multiple
    class="js-choice"
    data-all-tags={JSON.stringify(allTags)}
    data-tag-counts={JSON.stringify(tagCounts)}
  >
    {allTags.map(tag => (
      <option value={tag}>{`${trainCaseToNormalCase(tag)} (${(tagCounts[tag])})`}</option>
    ))}
  </select>

</div>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    const tagSelectEl = document.getElementById('tag-select');
    const searchInput = document.getElementById('tag-search');
    const clearBtn = document.getElementById('clear-tags');
    const allCards = Array.from(document.querySelectorAll('.tool-card'));
    const revealedCards = new Set();
    let currentSort = 'alpha-asc';

    // Initialize Choices.js using your minimal example:
    const choices = new Choices(tagSelectEl, {
      removeItemButton: true,
      searchPlaceholderValue: 'Search tags...',
      shouldSort: false,
      itemSelectText: '', // <== this disables the "Press to select" tooltip text
    });

    function getSelectedTags() {
      return choices.getValue(true); // array of selected tag values
    }

    function filterCards() {
      const selectedTags = getSelectedTags();

      allCards.forEach(card => {
        const tags = JSON.parse(card.dataset.tags || '[]');
        const match = selectedTags.every(tag => tags.includes(tag));

        card.style.display = match || selectedTags.length === 0 ? '' : 'none';
      });

      document.querySelectorAll('.tool-tag').forEach(chip => {
        const tag = chip.dataset.tag;
        chip.classList.toggle('selected', selectedTags.includes(tag));
      });
    }

    // Choices change listener
    tagSelectEl.addEventListener('change', () => {
      filterCards();
    });

    // Desktop tag search (filters tag list)
    searchInput?.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      document.querySelectorAll('.tag-list .tool-tag').forEach(tag => {
        const text = tag.textContent?.toLowerCase() || '';
        tag.style.display = text.includes(query) ? '' : 'none';
      });
    });

    // Clear all button
    clearBtn?.addEventListener('click', () => {
      choices.removeActiveItems();
      filterCards();

      document.querySelectorAll('.tool-tag').forEach(tag => {
        tag.style.display = '';
      });
    });

    // Tag sorting
    function renderTags(sortBy = currentSort) {
      const tagSelectEl = document.getElementById('tag-select');
      const allTags = JSON.parse(tagSelectEl.dataset.allTags);
      const tagCounts = JSON.parse(tagSelectEl.dataset.tagCounts);

      function trainCaseToNormalCase(tag) {
        return tag
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }
      // Build a sorted array of tag strings (not DOM elements)
      const sortFuncs = {
        'alpha-asc': (a, b) => a.localeCompare(b),
        'alpha-desc': (a, b) => b.localeCompare(a),
        'count-asc': (a, b) => (tagCounts[a] || 0) - (tagCounts[b] || 0),
        'count-desc': (a, b) => (tagCounts[b] || 0) - (tagCounts[a] || 0),
      };

      const sortedTags = [...allTags].sort(sortFuncs[sortBy]);

      // Update Choices.js dropdown
      choices.setChoices(
        sortedTags.map(tag => ({
          value: tag,
          label: `${trainCaseToNormalCase(tag)} (${tagCounts[tag]})`,
          selected: getSelectedTags().includes(tag),
        })),
        'value',
        'label',
        true // replaceChoices
      );
    }



    document.getElementById('sort-alpha-asc')?.addEventListener('click', () => {
      currentSort = 'alpha-asc';
      renderTags();
    });
    document.getElementById('sort-alpha-desc')?.addEventListener('click', () => {
      currentSort = 'alpha-desc';
      renderTags();
    });
    document.getElementById('sort-count-asc')?.addEventListener('click', () => {
      currentSort = 'count-asc';
      renderTags();
    });
    document.getElementById('sort-count-desc')?.addEventListener('click', () => {
      currentSort = 'count-desc';
      renderTags();
    });

    // Initial reveal
    allCards.forEach(card => {
      if (card.offsetParent !== null) {
        card.classList.add('fade-in');
        revealedCards.add(card);
      }
    });
  });
</script>

<style>
  .tag-panel {
    padding: 1rem;
    background: var(--clr-sidebar-bg);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .tag-heading {
    font-size: 1rem;
    font-weight: 600;
    color: white;
  }

  .tag-search {
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
    border-radius: 0.25rem;
    border: 1px solid var(--clr-lossless-primary-glass);
    background-color: var(--clr-lossless-primary-dark);
    color: white;
    width: 100%;
  }

  .tag-actions {
    display: flex;
    justify-content: flex-start;
  }

  .clear-tags-btn {
    background: transparent;
    border: 1px solid white;
    color: white;
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .clear-tags-btn:hover {
    background-color: white;
    color: black;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    max-height: 60vh;
    overflow-y: auto;
    overflow-x: hidden;
    width: 100%;
    box-sizing: border-box;
    border-bottom: 5px solid var(--clr-lossless-ui-btn-border);
  }

  .sort-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sort-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
    transition: transform 0.2s;
    display: inline-block;
    color: white;
  }

  .sort-btn:hover svg {
    transform: scale(1.1);
  }

  @media (max-width: 768px) {
    #tag-select {
      display: block;
      width: 100%;
      padding: 0.4rem;
      font-size: 1rem;
    }
  }


</style>

<style is:global>
.choices__inner {
  background-color: var(--clr-lossless-primary-dark) !important;
  border: 1px solid var(--clr-lossless-primary-glass) !important;
  color: white !important;
}

/* Selected pills */
.choices__list--multiple .choices__item {
  background-color: var(--clr-lossless-primary-glass) !important;
  color: white !important;
}

/* Dropdown */
.choices__list--dropdown {
  background-color: var(--clr-lossless-primary-dark) !important;
  color: white !important;
}

.choices__item--choice {
  color: white !important;
}

.choices__item--choice.is-highlighted {
  background-color: var(--clr-lossless-primary-glass) !important;
  color: white !important;
}

.choices__input {
  background-color: var(--clr-lossless-primary-dark) !important;
  color: white !important;
  border: none !important;
  box-shadow: none !important;
}


</style>
